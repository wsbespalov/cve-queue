import datetime
import sys
from xml.sax import make_parser

from settings import *
from getfile import getFile
from hnd_cve import CVEHandler
from mongo import *
from threadpool import ThreadPool

pool = ThreadPool(4)


def populate(args=None):
    start = datetime.datetime.now()
    if get_collection_size('cves') > 0:
        print("database already populated")
    else:
        print("Database population started")
        year = datetime.datetime.now().year + 1
        for x in range(START_YEAR, year):
            parser = make_parser()
            ch = CVEHandler()
            parser.setContentHandler(ch)
            getfile = FILE_PREFIX + str(x) + FILE_SUFFIX
            try:
                (f, r) = getFile(SOURCE_CVE + getfile)
            except:
                return "Cannot open url: %s" % (SOURCE_CVE + getfile)
            parser.parse(f)
            for item in ch.cves:
                print(item['id'])
            for item in ch.cves:
                if 'cvss' in item:
                    item['cvss'] = float(item['cvss'])
            if len(ch.cves) != 0:
                print("Importing CVEs for year " + str(x))
                pool.add_task(insert_cve, ch.cves)
            else:
                print("Year " + str(x) + " has no CVE's.")
    pool.wait_completion()
    end = datetime.datetime.now()
    delta = end - start
    print('complete: %s' % delta)

if __name__ == '__main__':
    populate()
