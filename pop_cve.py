import bz2
import datetime
import gzip
import sys
import urllib.request as req
import zipfile
from io import BytesIO
from xml.sax import make_parser

import pymongo

from hnd_cve import CVEHandler
from threadpool import ThreadPool

mongo = pymongo.MongoClient(
    host='localhost',
    port=27017,
    connect=True)["cvedb"]
colINFO = mongo['info']
colCVE = mongo['cves']

file_prefix = "nvdcve-2.0-"
file_suffix = ".xml.gz"
file_mod = "modified"
file_rec = "recent"

def setColUpdate(collection, date):
  colINFO.update({"db": collection}, {"$set": {"last-modified": date}}, upsert=True)

def setColInfo(collection, field, data):
  colINFO.update({"db": collection}, {"$set": {field: data}}, upsert=True)

def insertCVE(cve):
  colCVE.insert(cve)

def updateCVE(cve):
  colCVE.update({"id": cve['id']}, {"$set": {"cvss": cve['cvss'], "summary": cve['summary'], "references": cve['references'],
                                             "cwe": cve['cwe'], "vulnerable_configuration": cve['vulnerable_configuration'],
                                             "vulnerable_configuration_cpe_2_2": cve['vulnerable_configuration_cpe_2_2'], 'last-modified': cve['Modified']}})

def getCVE(id, collection=None):
  col=colCVE if not collection else mongo[collection]
  return sanitize(
      col.find_one(
          {"id": id}))

def getInfo(collection):
  return sanitize(
      colINFO.find_one(
          {"db": collection}))

def getSize(collection):
  return mongo[collection].count()

date = datetime.datetime.now()
year = date.year + 1
defaultvalue = {}
defaultvalue['cwe'] = "Unknown"
http_proxy = None
cveStartYear = 2017
source = "https://static.nvd.nist.gov/feeds/xml/cve/"

def progressbar(it, prefix="Preparing ", size=50):
    count = len(it)

    def _show(_i):
        if count != 0 and sys.stdout.isatty():
            x = int(size * _i / count)
            sys.stdout.write("%s[%s%s] %i/%i\r" % (prefix, "#" * x, " " * (size - x), _i, count))
            sys.stdout.flush()

    _show(0)
    for i, item in enumerate(it):
        yield item
        _show(i + 1)
    sys.stdout.write("\n")
    sys.stdout.flush()

def getFile(getfile, unpack=True):
    if http_proxy:
        proxy = req.ProxyHandler({'http': http_proxy, 'https': http_proxy})
        auth = req.HTTPBasicAuthHandler()
        opener = req.build_opener(proxy, auth, req.HTTPHandler)
        req.install_opener(opener)
    response = req.urlopen(getfile)
    data = response
    if unpack:
        if   'gzip' in response.info().get('Content-Type'):
            buf = BytesIO(response.read())
            data = gzip.GzipFile(fileobj=buf)
        elif 'bzip2' in response.info().get('Content-Type'):
            data = BytesIO(bz2.decompress(response.read()))
        elif 'zip' in response.info().get('Content-Type'):
            fzip = zipfile.ZipFile(BytesIO(response.read()), 'r')
            if len(fzip.namelist())>0:
                data=BytesIO(fzip.read(fzip.namelist()[0]))
    return (data, response)

def sanitize(x):
    if type(x)==pymongo.cursor.Cursor:
        x=list(x)
    if type(x)==list:
        for y in x:
          sanitize(y)
    if x and  "_id" in x:
        x.pop("_id")
    return x

pool = ThreadPool(4)

def populate():
    c = getSize('cves')
    if c > 0:
        print("database already populated")
    else:
        print("Database population started")
        for x in range(cveStartYear, year):
            parser = make_parser()
            ch = CVEHandler()
            parser.setContentHandler(ch)
            getfile = file_prefix + str(x) + file_suffix
            try:
                (f, r) = getFile(source + getfile)
            except:
                sys.exit("Cannot open url %s. Bad URL or not connected to the internet?" % (
                source + getfile))
            parser.parse(f)
            for item in ch.cves:
                print(item['id'])
            for item in ch.cves:
                if 'cvss' in item:
                    item['cvss'] = float(item['cvss'])
            # check if year is not cve-free
            if len(ch.cves) != 0:
                print("Importing CVEs for year " + str(x))
                # insertCVE(ch.cves)
                pool.add_task(insertCVE, ch.cves)
            else:
                print("Year " + str(x) + " has no CVE's.")

if __name__ == '__main__':
    start = datetime.datetime.now()
    populate()
    pool.wait_completion()
    end = datetime.datetime.now()
    delta = end - start
    print('complete: %s' % delta)