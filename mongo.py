import pymongo

mongo = pymongo.MongoClient(
    host='localhost',
    port=27017,
    connect=True)["cvedb"]


collection_INFO = mongo['info']
collection_CVE = mongo['cves']


def sanitize(x):
    if type(x) == pymongo.cursor.Cursor:
        x=list(x)
    if type(x)==list:
        for y in x:
            sanitize(y)
    if x and  "_id" in x:
        x.pop("_id")
    return x


def set_collection_update(collection, date):
    collection_INFO.update(
        {"db": collection},
        {"$set": {
            "last-modified": date}},
        upsert=True)


def set_collection_info(collection, field, data):
    collection_INFO.update(
        {"db": collection},
        {"$set": {
            field: data}},
        upsert=True)


def insert_cve(cve):
    collection_CVE.insert(cve)


def update_cve(cve):
    collection_CVE.update(
        {"id": cve['id']},
        {"$set": {
            "cvss": cve['cvss'],
            "summary": cve['summary'],
            "references": cve['references'],
            "cwe": cve['cwe'],
            "vulnerable_configuration": cve['vulnerable_configuration'],
            "vulnerable_configuration_cpe_2_2": cve['vulnerable_configuration_cpe_2_2'],
            'last-modified': cve['Modified']}})


def get_cve(id, collection=None):
    col = collection_CVE if not collection else mongo[collection]
    return sanitize(col.find_one({"id": id}))


def get_info(collection):
    return sanitize(
        collection_INFO.find_one(
            {"db": collection}))


def get_collection_size(collection):
    return mongo[collection].count()